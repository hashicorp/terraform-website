version: 2

jobs:
  website-docker-image:
    docker:
      - image: circleci/buildpack-deps
    shell: /usr/bin/env bash -euo pipefail -c
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.14
      - run:
          name: Pull submodules
          command: git submodule update --init
      - run:
          name: Build Docker Image if Necessary
          command: |
            if  [ "$CIRCLE_REPOSITORY_URL" != "git@github.com:hashicorp/terraform-website.git" ]; then
              echo "Not Terraform Website Repo, not building website docker image"
              exit 0
            else
              echo "Building full image..."
              docker login -u $WEBSITE_DOCKER_USER -p $WEBSITE_DOCKER_PASS
              docker buildx build \
                --platform linux/amd64,linux/arm64 \
                --push \
                -t hashicorp/terraform-website:$CIRCLE_SHA1 \
                -t hashicorp/terraform-website:full \
                .
              IMAGE_TAG="$(git rev-list -n1 HEAD -- Dockerfile package-lock.json)"
              echo "Using $IMAGE_TAG for latest image"
              if curl https://hub.docker.com/v2/repositories/hashicorp/terraform-website/tags/$IMAGE_TAG -fsL > /dev/null; then
                echo "Dependencies have not changed, not building a new website base docker image."
              else
                echo "Building base image..."
                docker buildx build \
                  --platform linux/amd64,linux/arm64 \
                  --push \
                  -t hashicorp/terraform-website:$IMAGE_TAG \
                  -t hashicorp/terraform-website:latest \
                  --target base \
                  .
              fi
            fi
workflows:
  version: 2
  website:
    jobs:
      - website-docker-image:
          filters:
            branches:
              only:
                - master
